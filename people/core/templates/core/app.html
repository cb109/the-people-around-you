<div id="app">
  <!-- Main fixed UI -->
  <div
    style="
      position: fixed;
      padding: 16px;
      z-index: 9999;
    "
  >
    <button
      type="button"
      @click="showDialog = true"
    >
      Add Person
    </button>
    <!-- Add-Person Dialog -->
    <div class="modal modal-sm" :class="{active: showDialog}">
      <a href="#close" class="modal-overlay" @click="closeDialog()"></a>
      <div class="modal-container">
        <div class="modal-header"><a class="btn btn-clear float-right" href="#close" @click="closeDialog()"></a>
          <div class="modal-title h5">Add Person</div>
        </div>
        <div class="modal-body">
          <div class="content">
            <form>
              <div class="form-group">
                <label class="form-label" for="first_name">First Name</label>
                <input class="form-input" id="first_name" v-model="firstName" type="text" placeholder="John">
              </div>
              <div class="form-group">
                <label class="form-label" for="last_name">Last Name</label>
                <input class="form-input" id="last_name"v-model="lastName" type="text" placeholder="Doe">
              </div>
            </form>
          </div>
        </div>
        <div class="modal-footer">
          <button
            :disabled="!dialogFormIsValid"
            class="btn btn-primary"
            @click="createPerson()"
          >
            Add
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Konva Stage -->
  <v-stage
    ref="stage"
    :config="configKonva"
  >
    <v-layer ref="layer">
      <template
        v-for="(person, personIndex) in persons"
        :key="'person-' + personIndex"
      >
        <v-group
          :config="{
            draggable: true,
            x: person.x,
            y: person.y,
          }"
          @dragend="onPersonMoved($event, person)"
          @touchend="onPersonMoved($event, person)"
        >
          <v-group
            :config="{
              clipFunc: clipFuncCircle,
            }"
          >
            <v-image
              :key="person.image"
              :config="{
                image: person.image,
              }"
            />
          </v-group>
          <v-group>
            <v-text
              :config="{
                x: 0,
                y: 320,
                width: 300,
                text: person.first_name + ' ' + person.last_name,
                align: 'center',
                fontSize: 32,
              }"
            />
          </v-group>
        </v-group>
      </template>
    </v-layer>
  </v-stage>
</div>

<script>
  // Setup person list as passed from Django initially.
  const initialPersons = [
    {% for person in initial_persons %}
      {
        id: {{ person.id }},
        first_name: "{{ person.first_name }}",
        last_name: "{{ person.last_name }}",
        x: {{ person.x }},
        y: {{ person.y }},
        avatar: "{{ person.avatar }}",
        image: null,
      },
    {% endfor %}
  ];

  function clipFuncCircle (ctx) {
    ctx.arc(150, 150, 150, 0, Math.PI * 2, false);
  }

  const app = Vue.createApp({
    delimiters: ['[[', ']]'],
    data() {
      return {
        // Konva
        clipFuncCircle: clipFuncCircle,
        configKonva: {
          width: window.innerWidth,
          height: window.innerHeight,
          draggable: true,
        },
        // Main fixed UI
        showDialog: false,
        firstName: '',
        lastName: '',
        // Backend data
        persons: initialPersons,
      };
    },
    computed: {
      dialogFormIsValid() {
        return (
          !!this.firstName && !this.firstName.trim() == '' &&
          !!this.lastName && !this.lastName.trim() == ''
        );
      },
    },
    created() {
      this.loadPersonImages();
    },
    mounted() {
      this.setupZoom();
    },
    methods: {
      resetDialog() {
        this.firstName = '';
        this.lastName = '';
      },
      closeDialog() {
        this.showDialog = false;
      },
      createPerson() {
        const vm = this;
        const payload = {
          first_name: this.firstName,
          last_name: this.lastName,
        };
        httpPost('/persons/create', payload)
          .then((response) => response.json())
          .then((person) => {
            function callback(person) {
              vm.persons.push(person);
            }
            vm.loadPersonImage(person, callback);
            vm.resetDialog();
            vm.closeDialog();
          });
      },
      onPersonMoved(e, person) {
        const payload = {
          x: e.target.attrs.x,
          y: e.target.attrs.y,
        };
        httpPost('/persons/' + person.id, payload);
      },
      loadPersonImages() {
        for (let person of this.persons) {
          this.loadPersonImage(person);
        };
      },
      loadPersonImage(person, callback = null) {
        const image = new Image();
        if (!person.avatar) {
          return;
        }
        image.src = person.avatar;
        image.onload = () => {
          person.image = image;
          if (callback) {
            callback(person);
          }
          console.log('loaded img of person', person);
        };
      },
      setupZoom() {
        const stage = this.$refs.stage.getStage();
        const scaleBy = 1.12;
        stage.on('wheel', (e) => {
          // stop default scrolling
          e.evt.preventDefault();

          var oldScale = stage.scaleX();
          var pointer = stage.getPointerPosition();

          var mousePointTo = {
            x: (pointer.x - stage.x()) / oldScale,
            y: (pointer.y - stage.y()) / oldScale,
          };

          // how to scale? Zoom in? Or zoom out?
          let direction = e.evt.deltaY > 0 ? -1 : 1;

          // when we zoom on trackpad, e.evt.ctrlKey is true
          // in that case lets revert direction
          if (e.evt.ctrlKey) {
            direction = -direction;
          }

          var newScale = direction > 0 ? oldScale * scaleBy : oldScale / scaleBy;

          stage.scale({ x: newScale, y: newScale });

          var newPos = {
            x: pointer.x - mousePointTo.x * newScale,
            y: pointer.y - mousePointTo.y * newScale,
          };
          stage.position(newPos);
        });
      },
    }
  });
  app.use(VueKonva);
  app.mount('#app');
</script>

<style>
  #app {
    width: 100vw;
    height: 100vh;
  }
</style>
